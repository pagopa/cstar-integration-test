# Run Automated Test in UAT environment

trigger: none

pool:
  vmImage: ubuntu-22.04

parameters:
  - name: 'SCRIPT'
    displayName: 'Script name'
    type: string
    values:
      - putTokenMockedPdv
      - putTokenPdv
      - idpayOnboardingAPI
  - name: 'TARGET_ENV'
    displayName: 'Target Environment'
    type: string
    default: 'uat'
    values:
      - 'dev'
      - 'uat'
  - name: 'SCENARIO_TYPE_ENV'
    displayName: 'Scenario type'
    type: string
    default: 'rampingArrivalRate'
    values:
      - 'rampingArrivalRate'
      - 'perVuIterations'
  - name: 'VIRTUAL_USERS_ENV'
    displayName: 'Number of virtual users (1 - 100 000)'
    type: number
  - name: 'STAGE_NUMBER_ENV'
    displayName: 'Number of ramping stages (min: 3)'
    type: number
    default: 3
  - name: 'DURATION_PER_VU_ITERATION'
    displayName: 'Maximum duration in seconds for the perVuIterations-type scenario'
    type: number
    default: 600
  - name: 'PDV_APIM_SK_ENV'
    displayName: 'PDV API-Key (required for putTokenPdv and idpayOnboardingAPI script)'
    type: string
    default: 'IGNORE_IF_putTokenMockedPdv'
  - name: 'SERVICEID'
    displayName: 'ServiceId (required for idpayOnboardingAPI script)'
    type: string
    default: 'IGNORE_IF_NOT_idpayOnboardingAPI'

steps:
  - task: DownloadSecureFile@1
    name: fc_pgpans
    displayName: 'Fiscal Code/PgPan File'
    inputs:
      secureFile: 'fc_pgpans.csv'
  - task: DownloadSecureFile@1
    name: fc_iban
    displayName: 'Fiscal Code/IBAN File'
    inputs:
      secureFile: 'fc_iban.csv'
  - script: |
      cp /home/vsts/work/_temp/fc_pgpans.csv $(pwd)/assets/fc_pgpans.csv
    displayName: Copy FiscalCode/PgPan File
  - script: |
       docker pull grafana/k6:latest
    displayName: Pull k6 image
  - script: |
      docker run -i \
        --name ksixtests \
        --user $UID \
        -v $(pwd):/app \
        --workdir "/app" \
        -e TARGET_ENV=${{ parameters.TARGET_ENV }} \
        -e SCENARIO_TYPE_ENV=${{ parameters.SCENARIO_TYPE_ENV }} \
        -e VIRTUAL_USERS_ENV=${{ parameters.VIRTUAL_USERS_ENV }} \
        -e STAGE_NUMBER_ENV=${{ parameters.STAGE_NUMBER_ENV }} \
        -e DURATION_PER_VU_ITERATION=${{ parameters.DURATION_PER_VU_ITERATION }} \
        -e PDV_APIM_SK_ENV=${{ parameters.PDV_APIM_SK_ENV }} \
        -e SERVICEID=${{ parameters.SERVICEID }} \
        -e FC_IBAN_FILE=$(fc_iban.secureFilePath) \
        grafana/k6:latest \
        run /app/test/performance/${{ parameters.SCRIPT }}.js
    displayName: Run k6 ${{ parameters.SCRIPT }}
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/performancetest-result.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      failTaskOnFailedTests: true

